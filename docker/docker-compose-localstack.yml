version: '3.5'

services:
  # dynamo:
  #   image: tradle/dynamodb-admin
  #   restart: always
  #   # dummy credentials
  #   ports:
  #     - ${DYNAMO_ADMIN_PORT}:8001
  #   environment:
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
  #     - DYNAMO_ENDPOINT=http://localstack:4569

  # needed for mosca (local MQTT server)
  redis:
    image: redis:latest
    restart: always
    ports:
      - 6379:6379
    volumes:
      - /data

  localstack:
    image: localstack/localstack:0.14.2
    restart: always
    platform: linux/arm64/v8
    network_mode: bridge
    ports:
      - "4566:4566"
      - "4567:4566"
      - "4568:4566"
      # - "4569:4569" # use dynalite instead
      - "4570:4566"
      - "4571:4566"
      - "4572:4566"
      - "4573:4566"
      - "4574:4566"
      - "4575:4566"
      - "4576:4566"
      - "4577:4566"
      - "4578:4566"
      - "4579:4566"
      - "4580:4566"
      - "4581:4566"
      - "4582:4566"
      - "4583:4566"
      - "4584:4566"
      - "8080:8080"
    environment:
      - SERVICES=${SERVICES- }
      - DEBUG=${DEBUG- }
      # - DATA_DIR=${DATA_DIR- }
      - LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR- }
      - KINESIS_ERROR_PROBABILITY=${KINESIS_ERROR_PROBABILITY- }
      - DOCKER_HOST=unix:///var/run/docker.sock
      - EXTRA_CORS_ALLOWED_ORIGINS=*
    volumes:
      - "$LOCALSTACK_DATA_DIR/main:/tmp/localstack/data"
      - "/var/run/docker.sock:/var/run/docker.sock"
  dynalite:
    restart: always
    image: tradle/dynalite:2.3.2
    ports:
      - 4569:4569
    volumes:
      - "$LOCALSTACK_DATA_DIR/dynalite:/db"
    command: dynalite --port 4569 --path /db
    user: root
#  tradle_web:
#    image: tradle/web-app:localstack
#    restart: always
#    container_name: tradle-web-app
#    restart: always
#    ports:
#      - "55555:80"
#    environment:
#      # if url contains any '~' characters, be sure to escape them:
#      - DEFAULT_TRADLE_SERVER_URL=${DEFAULT_TRADLE_SERVER_URL}
